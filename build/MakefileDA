#-*- Mode: Makefile -*-

ifdef DAMODULE

CXXFLAGS+=-I${ALICE_ROOT}/RAW

ifneq ($(EXTRADAMODULE),) 
CXXFLAGS+=-I${ALICE_ROOT}/$(EXTRADAMODULE)
endif

DASRC=${DAMODULE}/${DAMODULE}da.cxx
DADEP=${DAMODULE}/${DAMODULE}da.d
DAOBJ=${DAMODULE}/tgt_${ALICE_TARGET}/${DAMODULE}da.o
DALIB=${ALICE_ROOT}/lib/tgt_${ALICE_TARGET}/lib${DAMODULE}DA.a
DAEXE=${ALICE_ROOT}/bin/tgt_${ALICE_TARGET}/${DAMODULE}da.exe

DAMAKEFILE=${DAMODULE}/${DAMODULE}da.make

DAQDADIR=${ALICE}/daqDAlib
DAQDALIB=$(DAQDADIR)/libdaqDA.a

ROOTLIBDIR=$(shell root-config --libdir)

SYSLIBS=-ldl

MONITORLIBS=$(shell date-config --monitorlibs=noshift)

ALIROOTALIBS=$(RAWDatabaseALIB) $(RAWDatarecALIB) $(RAWDatasimALIB) $(STEERALIB) $(CDBALIB) $(ESDALIB)

ALIROOTALIBS+=$($(DAMODULE)baseALIB) $($(DAMODULE)recALIB) $($(DAMODULE)simALIB)

ifneq ($(EXTRADAMODULE),) 

ALIROOTALIBS+=$($(EXTRADAMODULE)baseALIB) $($(EXTRADAMODULE)recALIB) $($(EXTRADAMODULE)simALIB)

endif

static-DA: $(DAEXE)

$(DAEXE): $(LIBPATH) $(DAOBJ) $(DALIB) $(DAQDALIB)

	$(LD) $(LDFLAGS) -o $@ $(DAOBJ) $(DALIB) \
	$(SYSLIBS) \
	$(ROOTLIBDIR)/libRoot.a \
	$(ROOTLIBDIR)/libfreetype.a $(ROOTLIBDIR)/libpcre.a \
	$(MONITORLIBS) $(DAQDALIB)

$(DAOBJ): $(DASRC) $(DAQDADIR) $(DADEP)
	$(CXX) -c $(CXXFLAGS) -I$(DAQDADIR) $< -o $@

$(DADEP): $(DASRC) $(DAQDADIR)
	$(CPP) -MM $(CXXFLAGS) -I$(DAQDADIR) $< > $@

DAINCLUDES=$(sort $(filter-out %.o:,$(filter-out %.cxx,$(filter-out \,$(shell cat $(DADEP))))))

-include $(DADEP)

$(DALIB): $(ALIROOTALIBS)
	@rm -rf $@
	@rm -rf junk
	mkdir junk && cd junk && $(addprefix $(AR) x ../,$(addsuffix &&,$^)) $(AR) r $@ *.o && cd .. && rm -rf junk

clean-DA:
	@rm -f $(DAEXE)
	@rm -f $(DAOBJ)
	@rm -f $(DADEP)
	@rm -f $(DAMAKEFILE)
	@rm -f $(DALIB)
	@rm -f $(ALIROOTALIBS)

$(DAMAKEFILE):
	@echo "CXXFLAGS+=""$$""(shell date-config --cflags)" > $@
	@echo "CXXFLAGS+=-Iinclude" >> $@
	@echo "DAQDADIR=daqDAlib" >> $@
	@echo "DAQDALIB=""$$""(DAQDADIR)/libdaqDA.a" >> $@
	@echo "MONITORLIBS=""$$""(shell date-config --monitorlibs=noshift)" >> $@
	@echo "${DAMODULE}da.exe: ${DAMODULE}da.o" >> $@
	@echo "		""$$""(CXX) ""$$""(LDFLAGS) -o ""$$""@ ""$$""< \\" >> $@
	@echo "		lib/lib${DAMODULE}DA.a \\" >> $@
	@echo "		$(SYSLIBS) \\" >> $@
	@echo "		lib/libRoot.a \\" >> $@
	@echo "		lib/libfreetype.a lib/libpcre.a \\" >> $@
	@echo "		""$$""(MONITORLIBS) ""$$""(DAQDALIB)" >> $@
	@echo "${DAMODULE}da.o: ${DAMODULE}da.cxx" >> $@
	@echo "		""$$""(CXX) -c ""$$""(CXXFLAGS) -I""$$""(DAQDADIR) ""$$""< -o ""$$""@" >> $@
	@echo "clean:" >> $@
	@echo "		@rm -f ${DAMODULE}da.exe ${DAMODULE}da.o" >> $@

tar-DA: $(DASRC) $(DALIB) $(DAQDADIR) $(DADEP) $(DAMAKEFILE)
	@rm -rf $(DAMODULE)da.tar
	@rm -rf junk
	@mkdir junk && mkdir junk/lib && mkdir junk/include && \
	cp -a $(DASRC) $(DAQDADIR) junk && \
	cp -a $(DALIB) $(ROOTLIBDIR)/libRoot.a $(ROOTLIBDIR)/libfreetype.a $(ROOTLIBDIR)/libpcre.a junk/lib && \
	$(foreach daincfile,$(DAINCLUDES), cp -a $(daincfile) junk/include &&) \
	cp -a $(DAMAKEFILE) junk/Makefile && \
	cd junk && \
	tar cf ../$(DAMODULE)da.tar * && \
	cd .. && rm -rf junk

else

static-DA: clean-DA
clean-DA: tar-DA
tar-DA:
	@echo
	@echo "****************************************************************************************************"
	@echo "* In order to build a detector-algorithm package you have to set the environment variable DAMODULE *"
	@echo "* For example: setenv DAMODULE TOF                                                                 *"
	@echo "*          or  export DAMODULE=TOF                                                                 *"
	@echo "* If the detector algorithm uses data from another sub-detector you can specify this by setting    *"
	@echo "* the environment variable EXTRADAMODULE                                                           *"
	@echo "****************************************************************************************************"
	@echo


endif
