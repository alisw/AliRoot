<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
               "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="GENERATOR" content="Mozilla/4.51 [en] (X11; I; Linux 2.2.5-15 i686) [Netscape]">
   <title>PHOS Reconstruction Proposal</title>
<link REL="stylesheet" href="http://www-subatech.in2p3.fr/~photons/gps_alice.css" type="text/css">
</head>
<body>


<h1>
PHOS Reconstruction Proposal</h1>
At the Offline meeting held during the September ALICE week, it was decided
to make a major step in the design of the overall reconstruction framework.
This document presents the results of our early brainstorming about the
design of the reconstruction of the Photon Spectrometer PHOS.
<br>&nbsp;
<br>&nbsp;
<p>
<hr><a NAME="definitions and objectives"></a>
<h1>
Definitions and objectives</h1>

<h2>
What is PHOS ?</h2>
We hereby consider that the PHOS detector is the <i>union</i> of two sub-detectors
: the lead tungstate crystals and the Charged Particle Veto (CPV). Both
sub-detectors are physically organized in <i>modules</i>. A separate document
is dedicated to the <a href="PHOS_Proposal.html">PHOS geometry</a>.
<h2>
What is the reconstruction ?</h2>
Using the AliRoot framework, we would like to be able to compare several
CPV alternatives. The main focus will be on the photon identification capabilities
of PHOS, i.e. on the hadron rejection capabilities.
<p>This document describes the reconstruction software we intend to write/have
written to achieve this objective. <i>Reconstruction</i> is meant as the
full path from the PHOS digits to physical particles. The PHOS digits are
obtained by the simulation part of AliRoot.
<p>The PHOS reconstruction can be divided in three passes:
<dl>
<dt>
<b>Clusterization</b></dt>

<dd>
We group adjacent crystals (pads) with a signal over a given threshold
to form <i>clusters</i></dd>

<dt>
<b>Sub-Tracking</b></dt>

<dd>
Crystals and CPV clusters are associated to form PHOS <i>sub-tracks</i>.
Loosely speaking, a PHOS sub-track is just a crystal cluster with an information
on its charge.</dd>

<dt>
<b>Identification</b> (Tracking)</dt>

<dd>
Several (at least one) detector sub-tracks are combined and matched with
<i>particles</i>.</dd>
</dl>
The two first passes are detector specific, i.e. do not require any information
about other detectors. The last part may (and probably will) depend on
other detector reconstructions.

<p class="right">The key point in the following presented design is that
we want to be able to experiment several alternatives in each of the three
passes.
<h2>
Generalization</h2>
We often tried to generalized our design 'one step up', i.e. up to the
AliRoot framework itself, by defining pABC (pure Abstract Base Classes)
which we derive from. This is by no mean of way of saying that this is
the way to go. It's just a proposal, i.e. <i>a call for discussion</i>.
Also, we tried to make an effort on the class names, but you might find
our names strange or badly chosen. If this is the case, please <a href="mailto:aphecetc@in2p3.fr">tell
us</a> !
<br><!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
<hr>
<h1>
Clusterization</h1>
The clusterization part of the reconstruction can be summarized by the
following Use Case :
<center><img SRC="usecasereconstruction.gif" ALT="[Reconstruction Use Case]" height=355 width=599></center>
So, the basic functionalities we want here are :
<dl>
<dt>
<b>Storing/Retrieving data</b></dt>

<dd>
We want to <i>read</i> digits from file, and want to be able to <i>write</i>
clusters on file,</dd>

<dt>
<b>Clusterizing</b></dt>

<dd>
A separate document will detail the clusterization method(s).</dd>

<dt>
<b>Keeping track of what we did</b></dt>

<dd>
We would like to be able afterwards to answer questions like "I have a
cluster in hand, with which method has it been constructed ? With which
method parameters ?".</dd>
</dl>
We would like to insist on the last point. It is far more general than
a particular PHOS issue, and must be addressed in some way by the AliRoot
framework itself.
<p>The following class diagram outlines the clusterization part of the
PHOS reconstruction : a Clusterizer object groups some Digits into Clusters.
<center><img SRC="aliphosclusterization.gif" ALT="[Clusterization Class Diagram]" ></center>
The key point here is the possibility to actually change of clusterization
method (Clusterizer class) at runtime. The idea is to use the <a href="http://hillside.net/patterns/">Strategy
Design Pattern</a> (see <a href="#particle_identification">Particle Identification</a>
for a class diagram).
<p>The following tables presents a trial CRC study of the PHOS classes
related to the clusterization that lead to the above class diagram.
<br><!-- crc template 
<div class="crc">
<dl>
<dt><strong>Classname:</strong>
<dd><em class="classname">Ali</em>
<dt><strong>Superclasses :</strong>
<dd>Ali
<dt><strong>Subclasses :</strong>
<dd>Ali
<dt><strong>Responsabilities: </strong>
<dd>
<dt><strong>Collaborators: </strong>
<dd>Ali
</dl>
</div>
-->
<hr class="small-separation">
<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliPHOSDigit</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
AliDigit</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
AliPHOSCrystalDigit, AliPHOSCPVDigit</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
Base class for the storage of PHOS digits. Must identify digits (module,row,column)
and give access to the corresponding signal (energy).
<br>It can be added to an AliPHOSCluster.</dd>
<dt>
<b>Collaborators:</b></dt>

<dd>
AliPHOSCluster</dd>
</dl>
</div>

<hr class="small-separation">
<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliPHOSCluster</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
AliCluster (?)</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
AliPHOSCrystalCluster, AliPHOSCPVCluster</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
Base class for PHOS Xtal/CPV clusters. A cluster must know its module,
its spatial position, must be able to add digits to itself and to give
access to (/iterates on) its digits.</dd>

<dt>
<b>Collaborators:</b></dt>

<dd>
AliPHOSDigit, AliPHOSGeometry</dd>
</dl>
</div>

<hr class="small-separation">
<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliPHOSGeometry</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
none</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
none</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
Handles several PHOS Xtal/CPV geometrical characteristics (sizes, positions,
etc...).
<br>This class is a <b>Singleton</b>.
</dd>
<dt>
<b>Collaborators:</b></dt>

<dd>
AliPHOS*Cluster, AliPHOSClusterizer*</dd>
</dl>
</div>

<hr class="small-separation">
<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliPHOSClusterizer*</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
AliClusterizer</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
none</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
Concrete class(es) which implements the makeClusters method. From a list
of Ali(PHOS)Digit, this method must compute a list of Ali(PHOS)Cluster.</dd>

<dt>
<b>Collaborators:</b></dt>

<dd>
AliPHOS*Digit, AliPHOS*Cluster</dd>
</dl>
</div>

<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliParameter</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
none</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
(?) probably many of them</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
pABC. Keep track of methods used and method parameters used. What should
be the basic interface for this ???</dd>

<dt>
<b>Collaborators:</b></dt>

<dd>
Many classes...</dd>
</dl>
</div>
<!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
<hr><a NAME="sub_tracking"></a>
<h1>
Sub-Tracking</h1>
Once we have crystal and CPV clusters, we must associate them to make what
we would like to call SubTracks. Doing sub-tracks from clusters is, from
the design point of view, much like going from digits to clusters. We should
be able to easily change the class which actually do the sub-tracking job
:
<center><img SRC="aliphossubtracking.gif" ALT="[SubTracking Class Diagram]"></center>

<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliPHOSSubTrack</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
AliSubTrack (?)</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
none</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
Concrete storage class for a PHOS subtrack. It must be able to give access
to its clusters, and to identify itself as being part of PHOS.</dd>

<dt>
<b>Collaborators:</b></dt>

<dd>
AliPHOSSubTracker*</dd>
</dl>
</div>

<hr class="small-separation">
<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliPHOSSubTracker*</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
AliSubTracker</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
none</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
Concrete class(es) which implements the makeSubTracks method. From a list
of Ali(PHOS)Cluster, this method must compute a list of Ali(PHOS)SubTrack.</dd>

<dt>
<b>Collaborators:</b></dt>

<dd>
AliPHOSCluster, AliPHOSSubTrack</dd>
</dl>
</div>
<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
<hr><a NAME="particle_identification"></a>
<h1>
Particle Identification</h1>
Clusterization and subtracking are two activities that are <i>detector-driven</i>.
We can indeed imagine that the full ALICE reconstruction could be (pseudo-)coded
in AliRoot like :
<pre class="code">for each detector in ALICE do {
&nbsp; detector->Reconstruction() ;
}</pre>
assuming that each detector provides a Reconstruction method, and that
there's a way to parametrize each detector's behavior. The latter could
be done in the initialization phase of AliRoot, e.g. in the <tt>Config.C</tt>
file :
<pre class="code"><i>// Create PHOS clusterizers
</i>AliPHOSCrystalClusterizerV1 aXtalClusterizer(...) ;
AliPHOSCPVClusterizerV3 aCPVClusterizer(...) ;
<i>// Create PHOS SubTracker
</i>AliPHOSSubTrackerV0 aPHOSSubTracker(...) ;
<i>// Create a PHOS Reconstructioner
</i>AliPHOSReconstructioner aPHOSReconstructioner(aXtalClusterizer,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aCPVClusterizer,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aPHOSSubTracker) ;

<i>// Create PHOS detector and associate
&nbsp;a reconstructioner with it
</i>AliPHOS* phos = new AliPHOSVxx("PHOS",
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "PHOS Version xx",
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;;aPHOSReconstructioner) ;</pre>
In the above code, the clusterization strategies (for Xtals and CPV) and
the sub-tracking strategy are managed by a control class AliPHOSReconstrutioner
which would derive from a pABC AliReconstructioner.
<center><img SRC="aliphosreconstructioner.gif" ALT="[Reconstruction Class Diagram]" height=312 width=484></center>
The <tt>detector->Reconstruction()</tt> method would then only delegate
its job to the selected Reconstructioner (aPHOSReconstructioner in the
above example).
<p>If we now turn to the particle identification problem, two cases must
be considered :
<dl>
<dt>
<b>Standalone PHOS</b></dt>

<dd>
The particle identification is just a refinement (e.g. computation of some
new values to cut upon) of subtracking. We only need to access PHOS SubTracks.</dd>

<dt>
<b>PHOS + other ALICE sub-systems</b></dt>

<dd>
In this case, we must associate several subtracks, coming from different
sub-systems, in order to identify particles. One problem to solve is how
to access other sub-systems SubTracks.</dd>
</dl>
For this stage of the analysis, the AliRoot activity can not be detector-driven
anymore. Instead we would like to propose this activity to be <i>particle
hunting driven</i>. For example :
<pre class="code"><i>// we assume that all detectors have produced their subtracks in the event event_number
</i>AliParticleHunter* aPhotonFinder = new AliPhotonFinder(...) ;

<i>/* the UseDetector("ADET") method should "connect"
&nbsp;the ParticleHunter with the ADET subtrack branch so it can access
&nbsp;other detectors subtracks.
&nbsp;We assume that a subtrack knows in which detector she is, so we
&nbsp;can recover this information later (e.g. in the FindParticles method).
*/

</i>aPhotonFinder->UseDetector("ITS") ;
aPhotonFinder->UseDetector("TPC") ;
aPhotonFinder->UseDetector("PHOS") ;

for each event do {
&nbsp; aPhotonFinder->FetchSubTracks(event) ;
&nbsp; <i>/* The FindParticle method can now plays
&nbsp;&nbsp; with all the ITS,TPC and PHOS subtracks... */
</i>&nbsp; aPhotonFinder->FindParticles() ;
}</pre>

<center><img SRC="classes_identification.gif" ALT="[Identification Class Diagram]" height=279 width=480></center>

<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliPHOSReconstructioner*</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
AliReconstructioner (?)</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
none</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
This class is control class for the clusterizations and the subtracking.
It must handles the clusters and subtracks IO. It can be "added" to the
AliPHOS detector.</dd>

<dt>
<b>Collaborators:</b></dt>

<dd>
AliPHOSClusterizer, AliPHOSSubTracker, AliPHOS</dd>
</dl>
</div>

<div class="crc">
<dl>
<dt>
<b>Classname:</b></dt>

<dd>
<i>AliParticleHunter</i></dd>

<dt>
<b>Superclasses :</b></dt>

<dd>
non</dd>

<dt>
<b>Subclasses :</b></dt>

<dd>
AliPhotonFinder</dd>

<dt>
<b>Responsabilities:</b></dt>

<dd>
Associate a number (1..n) different detector subtracks to identify particles.
It must be able to fetch subtracks for a number of different detectors.
It handle IO of produced particles.</dd>

<dt>
<b>Collaborators:</b></dt>

<dd>
AliSubTrack, AliParticle, AliDetector</dd>
</dl>
</div>
<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
<hr>
<h1>
Disk Storage Structure</h1>
We present in this section how the PHOS reconstructed data will be arranged
on disk.
<p>We suppose that there is one TreeR (Reconstruction Tree) per event,
and we store different kinds of objects in differents branches, i.e. the
<b>PHOSCPVClusters
branch</b> contains CPV clusters the <b>PHOSCrystalClusters branch</b>
contains Crystal clusters, the <b>PHOSSubTracks branch</b> contains PHOS
SubTracks, and the <b>PHOSParameters branch</b> contains several information
related to the way Clusters and SubTracks were made. The following figure
indicates the inter-relation(s) between those branches and the relation
between those branches and the PHOS branch in the Digit Tree.
<center><img SRC="TreeR.gif" ALT="[Reconstruction Tree Structure]" height=425 width=483></center>

<h2>
How are the links implemented ?</h2>
If we assume that all the above branches are implemented using <a href="http://root.cern.ch/root/html/TClonesArray.html">TClonesArray</a>,
we could index things using simple integers refering to positions in the
TClonesArray. For example, a cluster will keep track of its digits by recording
the list of the digits position in the TClonesArray of the PHOS branch
in the digit tree. These positions are of course only valid within a given
event.
<p>If we want to be less implementation dependant we could probably have
classes such as <i>AliDigitIdentifier</i> (which could then be anything
we like, e.g. a simple integer wrapper or a set {event_number, index position}).
This solution could be more disk-space consuming, but would have the tremendous
advantage to isolate "logical" references from implementation.
<h2>
What should we save ?</h2>
At least in the beginning of the analysis, we should be able to perform
the reconstruction step by step, i.e. be able to save clusters, subtracks
and particles. It would be nice to include a switching mechanism to e.g.
disconnect the cluster output if we want to save disk space for instance.&nbsp;<!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
<hr><a NAME="parameters"></a>
<h1>
Keeping the entropy small</h1>
We come back to the problem stated in the clusterization section about
'keeping track of what we did'. We don't want to loose too much information
along our way from the raw data to the particles so we can have some checkpoints.
<p>We proposed in the above class diagrams to use a generic <tt>AliParameter</tt>
class which could answer question such as 'what was the sub-tracker method
and version used to do this sub-track ?' or 'what was the Xtal clustering
low threshold ?'. This 'AliParameter' could be accessible through methods
like <tt>AliParameter&amp; AliCluster::GetMakerInformation</tt>. That's
all nice, but we say nothing about what this AliParameter class is.
<p>We could imagine a very simple AliParameter implementation using e.g.
(parameter_name, parameter_value) pairs encapsulated in such an AliParameter
class. Or, entering fully the Alice Wonderland, we could dream of a much
more ambitious generic parameter class, in which the actual storage of
the parameters in done using <a href="http://www.w3.org">XML</a> (the W3
eXtensible Markup Language). The base AliParameter would then only provide
basic interface to code/decode XML tags, and each subsystems would provide
DTD to describes their parameters, which would then ressemble 'parameters
sheets'. We can imagine DTDs per detector or per domain (geometry, reconstruction,
physics analysis...).
<br>The strenght of this approach is the use of a (new) <b>standard</b>
in which data are represented in structured ASCII files. ASCII files are
human readable/produceable, easy to exchange between computers, and many
tools already exists, in a wide variety of languages (C/C++, Java, Perl,
Python...), to handles XML compliant files.
<p>But, well, may be this is only a dream... and too much work for our
purposes. Anyway, comments on this idea are welcome ! More information
can be found at <a href="http://www.oasis-open.org/cover/">http://www.oasis-open.org/cover/</a>
<br><!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
<hr>
<h1>
Summary</h1>
To perform the PHOS reconstruction, we need/propose the following classes
:
<h2>
New classes</h2>

<dl>
<dt>
<b>Ali(PHOS)Cluster</b></dt>

<dd>
(pABC) Storage class for groups of digits (per detector)</dd>

<dt>
<b>Ali(PHOS)SubTrack</b></dt>

<dd>
(pABC) Storage class for groups of clusters (per detector)</dd>

<dt>
<b>Ali(PHOS)Reconstructioner</b></dt>

<dd>
(pABC) Control class for clusterization and subtracking.</dd>

<dt>
<b>AliParticleHunter</b></dt>

<dd>
(pABC) Working class to associate different subtracks into particles.</dd>

<dt>
<b>AliParticle</b></dt>

<dd>
(pABC?) Storage class for particles.</dd>

<dt>
<b>AliParameter</b></dt>

<dd>
(pABC!) Entropy minimizing class. Keeps track of methods/parameters used
to make clusters, subtracks and particles.</dd>

<dt>
<b>Ali(Digit,Cluster,SubTrack)Identifier</b></dt>

<dd>
A simple integer wrapper or a more elaborated way of indexing reconstruction
objects, so we can go one step back at every analysis step (e.g. access
the list of clusters a subtrack is made of).</dd>
</dl>

<h2>
AliRoot classes impacted</h2>

<dl>
<dt>
<b>AliRun</b></dt>

<dd>
Add Reconstruction method, which would delegate to the corresponding Reconstruction
methods of the different detectors.</dd>

<dt>
<b>AliDetector</b></dt>

<dd>
Add GetSubTracks method (returning a list of subtracks for a given event),
and Reconstruction method (which delegates its jobs to an AliReconstructioner
object, selectable at runtime).</dd>
</dl>

<hr>
<address class="left">
&copy; <a href="mailto:aphecetc@in2p3.fr">Groupe Photons Subatech</a> <a href="http://www-subatech.in2p3.fr/~photons/subatech/en_index.shtml">[Go
to the GPS Home Page]</a></address>

<address class="right"> 
<!-- Created: Tue Oct 26 19:52:56 CEST 1999 -->
<!-- hhmts start -->
Last modified: Wed Dec  1 18:54:10 CET 1999
<!-- hhmts end --></address>

<div align=right><a href="http://validator.w3.org/check/referer"><img SRC="vh40.gif" ALT="Valid HTML 4.0!" BORDER=0 height=31 width=88></a><a href="http://jigsaw.w3.org/css-validator"><img SRC="vcss.gif" ALT="Valid CSS!" BORDER=0 height=31 width=88></a></div>

</body>
</html>
